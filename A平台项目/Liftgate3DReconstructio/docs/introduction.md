# 基本原理

## 三维重建

[三维重建（3D reconstruction）](https://en.wikipedia.org/wiki/3D_reconstruction)是指根据二维图像重建三维物体或场景的技术。三维重建的输入为一系列二维图像，输出为能尽量“解释”这些图像的三维物体或场景（以及各图像对应的相机位姿）。

在文献中，三维重建可以分为两种很接近的技术：

* 运动推断结构（Structure from Motion，SfM），根据运动摄像结果生成场景（比如通过航拍构建地形）；
* 多视觉立体视觉（Multiple View Stereo，MVS），根据多个角度的图像生成目标物体。

SfM 强调相机位姿估计，MVS 强调三维模型生成，所以可以认为三维重建分为 SfM 和 MVS 两个步骤，不过也有很多时候这两个术语是混用的。

目前已有不少三维重建软件，而且很多都是免费的。[Tanks and Temples](https://www.tanksandtemples.org/leaderboard/) 比较系统地评估了各软件的三维重建效果（精度）。不过除了效果外，易用性其实也是很重要的指标，好效果往往依赖于耗时的参数调整过程。

参照 [OpenMVG](https://github.com/openMVG/openMVG) + [OpenMVS](https://github.com/cdcseacave/openMVS) 流程，典型的三维重建可以分为以下 8 个步骤（前 4 个由 OpenMVG 实现，后 4 个由 OpenMVS 实现）：

1. 二维特征提取：选取图像中独特的区域（点），并用（通过某种算法转换的）一维向量来描述特征；
2. 二维特征匹配：找出两个图像间对应的特征区域（点），一般是基于描述特征的向量的度量距离（常用欧氏距离和汉明距离）的接近性；
3. 相机位姿估计：估计各图像对应的相机位姿，使得（任意）两个图像间的匹配特征尽量重合；
4. 稀疏点云生成：根据（任意）两个相机的位姿可以确定两个图像的匹配点的三维坐标，由此可以得到一系列三维点，这个过程又称为[三角化（triangulation）](https://en.wikipedia.org/wiki/Triangulation_%28computer_vision%29)；
5. 密集点云生成：根据稀疏点云和图像，估计各图像的[深度](https://en.wikipedia.org/wiki/Depth_map)，然后提取稀疏点云附近的三维点；
6. 网格模型生成：在各三维区域将点云转换为三角面；
7. 网格模型优化：基于图像优化网格模型；
8. 材质贴图生成：估计网格模型各部分的颜色。

实践中还可能包含其它环节，比如之前的镜头畸变修正和之后的 CAD 模型转换。

### 参考资料

* [MATLAB Structure from Motion](https://ww2.mathworks.cn/help/vision/ug/structure-from-motion.html)
* [OpenMVS Usage](https://github.com/cdcseacave/openMVS/wiki/Usage)

## 尾门三维重建

尾门三维重建和一般三维重建的主要区别是，一般三维重建针对单一静态物体，而尾门三维重建需要在不拆解的情况下得到车体和尾门两个部分，以及连接两个部分的铰链轴的位置。为此，需要在不同尾门开度下分别拍摄一组图片，先后以车体和尾门为对象进行三维重建。这一过程中还涉及了铰链轴识别，以及对应的相机位姿转换（重建车体时假定车体静止尾门运动，重建尾门时假定尾门静止车体运动）。

更具体地，Liftgate3DReconstruction 和一般三维重建相比，增加以下步骤：

* 参考板识别：从图像中辨识出国际象棋棋盘图案的参考板，以此初步估计相机位姿，以及重力方向（假定重力方向平行于参考板）；
* 对称面识别：假定车体左右对称，基于镜像后最大重合，识别出对称面；
* 铰链轴识别：假定铰链轴垂直于对称面，基于旋转后最大重合，识别出铰链轴和各组图像的尾门开度；
* 关门位置估计：基于尾门边缘和车体的最大重合，识别出关门时和各组图像的相对开度（因为参考板挡住，无法拍摄关门时的尾门）；
* 球铰识别：识别出车体和尾门上的 10 mm 直径球体；
* 电杆干涉识别：绘制关门时连接车身和尾门球铰间的 35 mm 直径圆柱与网格模型中附近区域的重叠情况。
